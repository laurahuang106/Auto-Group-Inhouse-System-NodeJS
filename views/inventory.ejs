<%- include("./header.ejs") %>
<body>
    <div class="main-container">
        <!-- Left section for filters -->
        <div class="search-filter-container">
            <h1>Inventory Report</h1>

            <form id="filter_form" action="./sale_orders.ejs" method="post">
                <div>
                    <label for="start_date_dropdown">Report Start Date</label>
                    <input type="date" name="start_date" id="start_date_dropdown">
                </div>

                <div>
                    <label for="end_date_dropdown">Report End Date</label>
                    <input type="date" name="end_date" id="end_date_dropdown">
                </div>
                
                <label for="employee_dropdown">Sales Person</label>
                <select name="employee_dropdown" id="employee_dropdown">
                    <option value="" selected></option>
                    <% sales_person_names.forEach(function(sales_person_name) { %>
                        <option value="<%= sales_person_name %>"><%= sales_person_name %></option>
                    <% }); %>
                </select>

                <label for="branch_dropdown">Branch</label>
                <select name="branch_dropdown" id="branch_dropdown">
                    <option value="" selected></option>
                    <% branches.forEach(function(branch) { %>
                        <option value="<%= branch %>"><%= branch %></option>
                    <% }); %>
                </select>

                <label for="make_dropdown">Make</label>
                <select name="make_dropdown" id="make_dropdown">
                    <option value="" selected></option>
                    <% makes.forEach(function(make) { %>
                        <option value="<%= make %>"><%= make %></option>
                    <% }); %>
                </select>

                <label for="model_dropdown">Model</label>
                <select name="model_dropdown" id="model_dropdown">
                    <option value="" selected></option>
                    <% models.forEach(function(model) { %>
                        <option value="<%= model %>"><%= model %></option>
                    <% }); %>
                </select>

                <label for="min_year_dropdown">Minimum Production Year</label>
                <select name="min_year_dropdown" id="min_year_dropdown">
                    <option value="" selected></option>
                    <!-- need change placeholder -->
                    <% years.forEach(function(year) { %>
                        <option value="<%= year %>"><%= year %></option>
                    <% }); %>
                </select>

                <label for="max_year_dropdown">Maximum Production Year</label>
                <select name="max_year_dropdown" id="max_year_dropdown">
                    <option value="" selected></option>
                    <!-- need change placeholder -->
                    <% years.forEach(function(year) { %>
                        <option value="<%= year %>"><%= year %></option>
                    <% }); %>
                </select>

                <label for="min_mile_dropdown">Minimum Mileage</label>
                <select name="min_mile_dropdown" id="min_mile_dropdown">
                    <option value="" selected></option>
                     <!-- need change placeholder -->
                     <% mileages.forEach(function(mileage) { %>
                        <option value="<%= mileage %>"><%= mileage %></option>
                    <% }); %>
                </select>

                <label for="max_mile_dropdown">Maximum Mileage</label>
                <select name="max_mile_dropdown" id="max_mile_dropdown">
                    <option value="" selected></option>
                    <!-- need change placeholder -->
                    <% mileages.forEach(function(mileage) { %>
                        <option value="<%= mileage %>"><%= mileage %></option>
                    <% }); %>
                </select>

                <button type="submit" id="submit_button">Apply Filters</button>
            </form>
        </div>

        <!-- Sorting Form -->
        <form id="sort_form" action="/inventory" method="get" style="display: none;">
            <input type="hidden" name="sort" id="sort_input">
        </form>

        <!-- Table Section -->
        <div class="report-section">
            <table>
                <thead>
                    <tr>
                        <th>
                            Buyin Date
                            <button type="button" onclick="sortTable('buyin_date')"> <%= sorting.buyin_date && sorting.buyin_date.includes('asc') ? '↑' : '↓' %> </button>
                        </th>
                        <th>
                            VIN
                            <button type="button" onclick="sortTable('VIN')"> <%= sorting.VIN && sorting.VIN.includes('asc') ? '↑' : '↓' %> </button>
                        </th>
                        <th>
                            Make
                            <button type="button" onclick="sortTable('make')"> <%= sorting.make && sorting.make.includes('asc') ? '↑' : '↓' %> </button>
                        </th>
                        <th>
                            Model
                            <button type="button" onclick="sortTable('model')"> <%= sorting.model && sorting.model.includes('asc') ? '↑' : '↓' %> </button>
                        </th>
                        <th>
                            Year
                            <button type="button" onclick="sortTable('year')"> <%= sorting.year && sorting.year.includes('asc') ? '↑' : '↓' %> </button>
                        </th>
                        <th>
                            Mileage
                            <button type="button" onclick="sortTable('mileage')"> <%= sorting.mileage && sorting.mileage.includes('asc') ? '↑' : '↓' %> </button>
                        </th>
                        <th>
                            Buyin Price
                            <button type="button" onclick="sortTable('buyin_price')"> <%= sorting.buyin_price && sorting.buyin_price.includes('asc') ? '↑' : '↓' %> </button>
                        </th>
                        <th>
                            Sales Name
                            <button type="button" onclick="sortTable('sales_person_name')"> <%= sorting.sales_person_name && sorting.sales_person_name.includes('asc') ? '↑' : '↓' %> </button>
                        </th>
                        <th>
                            Store Branch
                            <button type="button" onclick="sortTable('store_branch')"> <%= sorting.store_branch && sorting.store_branch.includes('asc') ? '↑' : '↓' %> </button>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <% records.forEach(record => { %>
                        <tr>
                            <td><%= record.buyin_date %></td>
                            <td><%= record.VIN %></td>
                            <td><%= record.make %></td>
                            <td><%= record.model %></td>
                            <td><%= record.year %></td>
                            <td><%= record.mileage %></td>
                            <td>$<%= record.buyin_price %></td>
                            <td><%= record.sales_person_name %></td>
                            <td><%= record.store_branch %></td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
        
        <script>
            // filters alerts
            document.addEventListener('DOMContentLoaded', function () {
                document.getElementById('filter_form').addEventListener('input', validateForm);
            });

            function validateForm() {
                console.log('Validating form'); // For debugging purposes

                const startDate = document.getElementById('start_date_dropdown').value;
                const endDate = document.getElementById('end_date_dropdown').value;
                const minYear = parseInt(document.getElementById('min_year_dropdown').value);
                const maxYear = parseInt(document.getElementById('max_year_dropdown').value);
                const minMileage = parseInt(document.getElementById('min_mile_dropdown').value);
                const maxMileage = parseInt(document.getElementById('max_mile_dropdown').value);
                
                let isValid = true;
                let errorMessage = '';

                // Validate that end date is not before start date
                if (startDate && endDate && endDate < startDate) {
                    isValid = false;
                    errorMessage += "End date cannot be earlier than start date.\n";
                }

                // Validate production year range
                if (minYear && maxYear && parseInt(maxYear) < parseInt(minYear)) {
                    isValid = false;
                    errorMessage += "Maximum production year cannot be earlier than minimum production year.\n";
                }

                // Validate mileage range
                if (minMileage && maxMileage && parseInt(maxMileage) < parseInt(minMileage)) {
                    isValid = false;
                    errorMessage += "Maximum mileage cannot be less than minimum mileage.\n";
                }

                if (!isValid) {
                    alert(errorMessage);
                }

                const submitButton = document.getElementById('submit_button');
                submitButton.disabled = !isValid;
            }

            // table filters
            function sortTable(column) {
                const currentOrder = document.getElementById('sort_input').value;
                const newOrder = currentOrder === column + '_asc' ? column + '_desc' : column + '_asc';
                document.getElementById('sort_input').value = newOrder;
                document.getElementById('sort_form').submit();
            }
        </script>
</body>
</html>

